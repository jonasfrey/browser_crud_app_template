# Improvements

Based on a full read of all source files as of 2026-02-21.

---

## Bugs (would cause runtime crashes)

### 1. `f_delete_table_data` not imported in `functions.js`

**File:** [functions.js:86](functions.js)

`o_wsmsg__f_delete_table_data.f_v_server_implementation` calls `f_delete_table_data(...)` but that symbol is never imported into `functions.js`. The correct name exported from `database_functions.js` is `f_db_delete_table_data`. Clicking "Delete all data" in the UI will throw a `ReferenceError` at runtime.

**Fix:** Import `f_db_delete_table_data` from `./database_functions.js` and call it instead.

---

### 2. `f_v_read_or_create_byid__fromdb` — broken and dead

**File:** [database_functions.js:173-184](database_functions.js)

Two bugs in this function:
- Parameter is `o_moel` (typo), not `o_model`
- Body references `o_model_instance` (undefined) instead of `o_instance` (the parameter)

The function is exported but never imported anywhere in the project. Either fix it or remove it.

---

### 3. `s_name_table__fsnode` undefined in `f_a_o_fsnode`

**File:** [functions.js:39](functions.js)

Inside `f_a_o_fsnode`, when `b_store_in_db` is `true`, the code uses `s_name_table__fsnode` which is never defined. Should be `f_s_name_table__from_o_model(o_model__o_fsnode)`. Since `b_store_in_db` defaults to `false` and the UI passes `false`, this doesn't crash in normal use — but the branch is silently broken.

---

## Bugs (wrong behavior, no crash)

### 4. Stale `o_socket` export after reconnect

**File:** [localhost/index.js:213](localhost/index.js)

`o_socket` is exported as a `let` initially set to `null`. After `f_connect()` runs, it points to the live socket. But on reconnect (the `onclose` handler calls `f_connect()` again), a new socket object is assigned to the module-level `o_socket` variable. Any component that imported `o_socket` at startup now holds a reference to the old, closed socket.

**Fix:** Export a getter function `f_o_socket` that always returns the current socket, or access it through the module namespace rather than a named export.

---

### 5. `o_course_o_student` key missing `a_` prefix in `o_state`

**File:** [localhost/index.js:44](localhost/index.js)

The table name generated by `f_s_name_table__from_o_model(o_model__o_course_o_student)` is `a_o_course_o_student`. But `o_state` initializes it as `o_course_o_student: []` (no `a_` prefix). The server sends `set_state_data` with the correct key `a_o_course_o_student`, which creates a new reactive key — but the initially declared `o_course_o_student` key is never populated and stays orphaned.

---

## Debug Leftovers

### 6. `console.log(o_request)` on every WebSocket upgrade

**File:** [websersocket_*.js:54](websersocket_550ad2f2-336e-458f-8311-e8082319b641.js)

Logs the full Deno `Request` object to the server console on every WebSocket connection. Should be removed or replaced with a targeted log (e.g. just the IP).

---

### 7. `console.log(o_state.a_o_model)` in component `created` hook

**File:** [localhost/o_component__data.js:279](localhost/o_component__data.js)

Debug log inside `created`. Remove.

---

### 8. Commented-out `console.*` calls in `constructors.js`

**File:** [localhost/constructors.js:170-175](localhost/constructors.js)

Six commented-out `console.log/error/warn/info/debug/table` lines sitting above the logmsg type constants. Remove.

---

## Naming Convention Violations

### 9. Model properties `name` should be `s_name`

**File:** [localhost/constructors.js:103, 113](localhost/constructors.js)

Both `o_model__o_student` and `o_model__o_course` define a property called `name` — no type prefix. Per the coding guidelines this must be `s_name`. This also means the DB column and every reference in `default_data.js` would need updating to match.

---

## Architectural / Design Issues

### 10. `o_state` model keys hardcoded in `index.js`

**File:** [localhost/index.js:42-44](localhost/index.js)

```js
a_o_course: [],
a_o_student: [],
o_course_o_student: [],   // also wrong prefix, see bug #5
```

These exist so Vue reactivity tracks them before the server sends `set_state_data`. But they must be kept manually in sync with `a_o_model` in `constructors.js`. When adding a new model, a developer has to remember to also add its key here.

**Fix:** Derive the initial keys automatically by iterating `a_o_model` at startup:
```js
for (let o_model of a_o_model) {
    o_state[f_s_name_table__from_o_model(o_model)] = [];
}
```

---

### 11. `handyhelpers` loaded from CDN at runtime

**Files:** [localhost/index.js:18](localhost/index.js), [localhost/o_component__data.js:7](localhost/o_component__data.js), [localhost/o_component__filebrowser.js:3](localhost/o_component__filebrowser.js)

All three files fetch `https://deno.land/x/handyhelpers@5.4.2/mod.js` at browser runtime. Unlike `vue` and `vue-router` which are bundled in `localhost/lib/`, this dependency requires internet access. The app will fail to load offline.

**Fix:** Download `handyhelpers` and place it in `localhost/lib/`, then point the import map at it (same pattern as Vue).

---

### 12. `f_send_wsmsg_with_response` never times out

**File:** [localhost/index.js:62-73](localhost/index.js)

The returned `Promise` never rejects or resolves if the server never sends back a matching `s_uuid`. A single missing server response permanently leaks the promise and its handler in `a_f_handler`.

**Fix:** Add a timeout (e.g. 10s) that rejects the promise and unregisters the handler.

---

## Security Notes (template context)

These are noted for awareness, not as urgent fixes — this template is intended for local/personal use, not public deployment.

### 13. `/api/file` endpoint reads arbitrary absolute paths

**File:** [websersocket_*.js:281-299](websersocket_550ad2f2-336e-458f-8311-e8082319b641.js)

`GET /api/file?path=/etc/passwd` would return that file with no restrictions. Fine for a local dev tool, but should have a comment warning that this must be restricted before any network-exposed deployment.

---

### 14. `deno_copy_file`, `deno_mkdir`, `deno_stat` expose raw Deno APIs to all WS clients

**File:** [functions.js:68-79](functions.js)

Any connected WebSocket client can call `Deno.copyFile`, `Deno.mkdir`, and `Deno.stat` with arbitrary arguments. Again fine for local use, but should carry a warning comment about production use.
